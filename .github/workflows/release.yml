name: Release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to release from'
        required: true
        default: 'main'
      version:
        description: 'Version number (e.g., v1.0.5)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v3
        with:
          ref: "${GITHUB_REF#refs/heads/}"

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable

      - name: Install cargo-release
        run: cargo install cargo-release

      - name: Build and Test Release
        run: |
          cargo build --release --verbose
          cargo test --release --verbose

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Publish
        run: |
          VERSION=${{ github.event.inputs.version }}
          BRANCH="${GITHUB_REF#refs/heads/}"

          echo "Logging into crates.io"
          cargo login ${{ secrets.CRATESIO_API_TOKEN }}

          echo "Releasing $VERSION" 
          # Update version in Cargo.toml
          # Commit to repo
          # Create git tag
          # Push changes
          cargo release --verbose --execute $VERSION
          
          # Push version commit and tag to github
          git push --tags origin $BRANCH
        env:
          CARGO_TERM_COLOR: always
    env:
      GITHUB_REF: ${{ github.ref }}

